
---

# Cap√≠tulo 2: Mono
## 2.4 Demonstra√ß√£o da Implementa√ß√£o Publisher/Subscriber

Com as implementa√ß√µes de `Publisher`, `Subscriber` e `Subscription` completas, √© hora de realizar uma s√©rie de testes para validar o comportamento reativo conforme os princ√≠pios da especifica√ß√£o **Reactive Streams**.

Neste cap√≠tulo, ser√° criada uma classe de demonstra√ß√£o com o m√©todo `main`, no qual diferentes cen√°rios s√£o simulados para refor√ßar a compreens√£o pr√°tica dos conceitos aprendidos.

---

## üß™ Estrutura da classe de demonstra√ß√£o

A classe de testes foi criada no pacote `com.francisco.sec01`, contendo o m√©todo `main` e m√©todos auxiliares `demo1`, `demo2`, `demo3` e `demo4`. Cada m√©todo testa um aspecto diferente da especifica√ß√£o:

---

### üîπ `demo1` ‚Äì Publisher n√£o envia dados sem solicita√ß√£o

```java
public static void demo1() {
    var publisher = new PublisherImpl();
    var subscriber = new SubscriberImpl();
    publisher.subscribe(subscriber);
}
```

**Resultado esperado:** Nada √© produzido. O `Publisher` s√≥ emite dados ap√≥s um `request`.

---

### üîπ `demo2` ‚Äì Emiss√£o sob demanda em lotes

```java
public static void demo2() throws InterruptedException {
    var publisher = new PublisherImpl();
    var subscriber = new SubscriberImpl();
    publisher.subscribe(subscriber);

    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
    subscriber.getSubscription().request(3);
}
```

**Resultado esperado:**
- O `Publisher` envia os e-mails em blocos de 3.
- A emiss√£o para ao atingir o limite de 10 itens (`MAX_ITEMS`).
- Caso o limite seja alcan√ßado no meio de uma solicita√ß√£o, apenas os itens restantes s√£o enviados e o fluxo √© encerrado com `onComplete()`.

---

### üîπ `demo2` (com `MAX_ITEMS = 0`) ‚Äì Produ√ß√£o zero

Este cen√°rio simula um caso onde **n√£o h√° dados dispon√≠veis** (como uma tabela vazia):

```java
private static final int MAX_ITEMS = 0;
```

**Resultado esperado:**
- Nenhum item √© emitido.
- O fluxo finaliza imediatamente com `onComplete()`.

---

### üîπ `demo3` ‚Äì Cancelamento da assinatura

```java
public static void demo3() throws InterruptedException {
    var publisher = new PublisherImpl();
    var subscriber = new SubscriberImpl();
    publisher.subscribe(subscriber);

    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
    subscriber.getSubscription().cancel();
    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
}
```

**Resultado esperado:**
- Os primeiros 3 itens s√£o emitidos.
- Ap√≥s o cancelamento, nenhuma nova emiss√£o ocorre.
- A chamada subsequente a `request()` √© ignorada.

---

### üîπ `demo4` ‚Äì Emiss√£o de erro (viola√ß√£o de regra)

Foi adicionada uma valida√ß√£o na `SubscriptionImpl` para simular um erro:

```java
if (requested > MAX_ITEMS) {
    subscriber.onError(new RuntimeException("validation failed"));
    isCancelled = true;
    return;
}
```

Teste correspondente:

```java
public static void demo4() throws InterruptedException {
    var publisher = new PublisherImpl();
    var subscriber = new SubscriberImpl();
    publisher.subscribe(subscriber);

    subscriber.getSubscription().request(3);
    Thread.sleep(Duration.ofSeconds(2));
    subscriber.getSubscription().request(11); // Deve causar erro
    subscriber.getSubscription().request(3);  // N√£o deve emitir
    Thread.sleep(Duration.ofSeconds(2));
}
```

**Resultado esperado:**
- Ap√≥s a tentativa de solicitar mais do que o permitido, o erro √© lan√ßado.
- O fluxo √© encerrado com `onError()`.
- Chamadas subsequentes a `request()` s√£o ignoradas.

---

## ‚úÖ O que aprendemos

- O `Publisher` s√≥ emite dados **mediante solicita√ß√£o expl√≠cita** do `Subscriber`.
- A **quantidade emitida respeita o valor solicitado** (ou menos, se atingir o limite).
- Ap√≥s o `cancel()`, nenhuma nova emiss√£o √© permitida.
- Erros podem ser sinalizados com `onError()`, encerrando o fluxo imediatamente.

---
